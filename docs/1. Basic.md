# 1. basic install

## architecture

![alt text](<images/1. Basic/image.png>)

## let's create it

1. create tinkerbell server (vm)

```sh
cd /tmp

touch meta-data
vi user-data

#cloud-config
ssh_pwauth: true # sshd service will be configured to accept password authentication method
disable_root: 0 #enable root login
users:
  - name: root
    plain_text_passwd: ragon
    lock_passwd: false
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCpLOZfSxSucnqv5cz1iMbobBkUAzzGABK7h8vQuGMe60RVSJOdOBSeO7eUtzkTq4CGgpZCeD89bJl1LBjt8LGBnlEkV+T17WnLf9bRSLJgJ/WosbcKwTnHJBi0DdLXMo63EYGQ1T2401gw5egfICgLyQOsu07caZodGMnRqKyQ6r9zIenyqM+o+hLrmycOoQOUmWjqqNvlhyjU9uTTHLNhtcT2daFzC4r6LNIHiaZpnJlbdGIS6I7yNIVlnL2Y2Xqy0nUXJ/G5Yyy3gYltNS0r2EuQtyRrzbRnOkQrgaKJKOCcw4wLRRgdfhJk+7lVwIZ1Bd7NNFWF1nAE1nOtceZJ
runcmd:
  - date >> /tmp/birth_certificate
  - reboot

wget https://repo.almalinux.org/almalinux/8/cloud/x86_64/images/AlmaLinux-8-GenericCloud-8.10-20240819.x86_64.qcow2

src=AlmaLinux-8-GenericCloud-8.10-20240819.x86_64.qcow2
name=tinkerbell

cp $src /tmp/$name.qcow2

virt-install \
  --import \
  --name $name \
  --memory 4048 \
  --vcpus 8 \
  --diskubectl -n $NAMESPACE /tmp/$name.qcow2,format=qcow2,bus=virtio \
  --cloud-init user-data=/tmp/user-data,meta-data=/tmp/meta-data \
  --networkubectl -n $NAMESPACE bridge=virbr0,model=virtio \
  --graphics vnc,listen=0.0.0.0 \
  --os-variant rhel8.0 \
  --console pty,target_type=serial \
  --noautoconsole

virsh start tinkerbell
virsh console tinkerbell

#아이피 확인
ip a

SERVERIP=192.168.122.188

# Internet 접속 확인
PING 4.2.2.2 (4.2.2.2) 56(84) bytes of data.
64 bytes from 4.2.2.2: icmp_seq=1 ttl=56 time=9.72 ms

ssh 192.168.122.201
```

## setup tinkerbell server

### install docker

```sh
dnf install -y wget git zsh

dnf config-manager --add-repo https://download.docker.com/linux/rhel/docker-ce.repo

dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

systemctl enable --now docker

docker ps -a
```

### install k3d

k3d is a lightweight wrapper to run k3s in docker. It is a great way to run Kubernetes clusters locally.

```sh
curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

k3d --help

k3d cluster list
k3d cluster delete k3s-default

# K3D_FIX_DNS=false is needed because host networkubectl -n $NAMESPACE mode won't workubectl -n $NAMESPACE without it.
K3D_FIX_DNS=false k3d cluster create --networkubectl -n $NAMESPACE host --no-lb --k3s-arg "--disable=traefik,servicelb,metrics-server,local-storage"

# `--networkubectl -n $NAMESPACE host` : host networkubectl -n $NAMESPACE is used to allow the load balancer to advertise a layer 2 address.
# `--no-lb` : the K3D built in load balancer is disabled so we don't have conflicts with the stackubectl -n $NAMESPACE load balancer.
# `--k3s-arg "--disable=traefik,servicelb,metrics-server,local-storage"` : disable the built in K3S load balancer, metrics server, and local storage.

k3d cluster list
> NAME          SERVERS   AGENTS   LOADBALANCER
> k3s-default   1/1       0/0      false

mkdir -p ~/.kube
k3d kubeconfig get k3s-default > ~/.kube/config

cat ~/.kube/config

docker logs -f k3d-k3s-default-server-0
```

## install kubectl

```sh
cd /tmp

curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"

install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
```

## install helm

```sh
cd /tmp
curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
chmod 700 get_helm.sh
./get_helm.sh

helm version
```

## install k9s

```sh
cd /tmp
wget https://github.com/derailed/k9s/releases/download/v0.26.7/k9s_Linux_x86_64.tar.gz
tar xvf k9s_Linux_x86_64.tar.gz
mv k9s /usr/local/bin/
```

## Install the Tinkerbell stackubectl -n $NAMESPACE Helm chart

```sh
# 0.6.2
# export LOADBALANCER_IP=192.168.122.201
# export LOADBALANCER_INTERFACE=eno1
# export HELM_CHART_VERSION=0.6.2
# export NAMESPACE=tinkerbell

# trusted_proxies=$(kubectl get nodes -o jsonpath='{.items[*].spec.podCIDR}' | tr ' ' ',')

# helm install tink-stackubectl -n $NAMESPACE oci://ghcr.io/tinkerbell/charts/stackubectl -n $NAMESPACE \
# 	--version $HELM_CHART_VERSION \
# 	--create-namespace \
# 	--namespace $NAMESPACE \
# 	--wait \
# 	--set "smee.trustedProxies={${trusted_proxies}}" \
# 	--set "hegel.trustedProxies={${trusted_proxies}}" \
# 	--set "stack.kubevip.interface=$LOADBALANCER_INTERFACE" \
# 	--set "stack.relay.sourceInterface=$LOADBALANCER_INTERFACE" \
# 	--set "stack.loadBalancerIP=$LOADBALANCER_IP" \
# 	--set "smee.publicIP=$LOADBALANCER_IP"

# 0.17
trusted_proxies=$(kubectl get nodes -o jsonpath='{.items[*].spec.podCIDR}' | tr ' ' ',')
export HELM_CHART_VERSION=v0.17
export LB_IP=192.168.122.250
export ARTIFACTS_FILE_SERVER=http://$SERVERIP:8080 # server itself ip 왜 그렇지?
export NAMESPACE=tinkerbell

helm install tinkerbell oci://ghcr.io/tinkerbell/charts/tinkerbell \
  --version "$HELM_CHART_VERSION" \
  --create-namespace \
  --namespace tinkerbell \
  --wait \
  --set "trustedProxies={${trusted_proxies}}" \
  --set "publicIP=$LB_IP" \
  --set "artifactsFileServer=$ARTIFACTS_FILE_SERVER"

kubectl get pods -n $NAMESPACE

kubectl get svc -n $NAMESPACE

mkdir -p /data/git

cd /data/git

git clone https://github.com/teamsmiley/tinkerbell-example.git

cd /data/git/tinkerbell-example/example

cd 1.basic

kubectl -n $NAMESPACE apply -f .

kubectl -n $NAMESPACE get svc
#nginx 192.168.122.251
```

![alt text](<images/1. Prerequisites/image.png>)

wait until all job done

```sh
docker exec -it k3d-k3s-default-server-0 ls -alF /opt/hook/

total 616268
drwxr-xr-x 2 root root        48 Apr 23 21:29 ./
drwxr-xr-x 3 root root        18 Apr 23 21:28 ../
-rw-r--r-- 1 root root 631055738 Apr 23 21:29 jammy-server-cloudimg-amd64.raw.gz
```

ubuntu download 완료

nginx ready to serviving image

```sh
kubectl -n $NAMESPACE get svc
```

![alt text](<images/1. Prerequisites/image-1.png>)

```sh
wget http://192.168.122.251:8080/jammy-server-cloudimg-amd64.raw.gz
```

download 테스트 완료

새로운 vm을 올리면 자동을 pxe가 되면서 부팅되야한다.

```sh
virt-install \
  --name test \
  --memory 4048 \
  --vcpus 8 \
  --diskubectl -n $NAMESPACE /tmp/test.qcow2,size=100 \
  --graphics vnc,listen=0.0.0.0\
  --networkubectl -n $NAMESPACE bridge=virbr0,model=virtio,mac=52:54:00:ff:54:38 \
  --console pty,target_type=serial \
  --pxe \
  --os-variant rhel8.0 \
  --noautoconsole

```

![alt text](<images/1. Prerequisites/image-2.png>)

```sh
virsh destroy test
virsh undefine test
rm -rf /tmp/test.qcow2
```

이제 vnc로 접속해서 확인하자.

```sh

```
