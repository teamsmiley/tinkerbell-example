# Prerequisites

1. install alma 8
1. disable selinux

1. disable firewalld

```sh
systemtl stop firewalld
systemctl disable firewalld
systemctl status firewalld
```

1. install kvm

```sh
dnf install -y qemu-kvm libvirt virt-install
systemctl enable --now libvirtd
systemctl status libvirtd
```

1. create vm

```sh
cd /tmp

touch meta-data
vi user-data

#cloud-config
ssh_pwauth: true # sshd service will be configured to accept password authentication method
disable_root: 0 #enable root login
users:
  - name: root
    plain_text_passwd: ragon
    lock_passwd: false
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCpLOZfSxSucnqv5cz1iMbobBkUAzzGABK7h8vQuGMe60RVSJOdOBSeO7eUtzkTq4CGgpZCeD89bJl1LBjt8LGBnlEkV+T17WnLf9bRSLJgJ/WosbcKwTnHJBi0DdLXMo63EYGQ1T2401gw5egfICgLyQOsu07caZodGMnRqKyQ6r9zIenyqM+o+hLrmycOoQOUmWjqqNvlhyjU9uTTHLNhtcT2daFzC4r6LNIHiaZpnJlbdGIS6I7yNIVlnL2Y2Xqy0nUXJ/G5Yyy3gYltNS0r2EuQtyRrzbRnOkQrgaKJKOCcw4wLRRgdfhJk+7lVwIZ1Bd7NNFWF1nAE1nOtceZJ
runcmd:
  - date >> /tmp/birth_certificate
  - reboot

wget https://repo.almalinux.org/almalinux/8/cloud/x86_64/images/AlmaLinux-8-GenericCloud-8.10-20240819.x86_64.qcow2

src=AlmaLinux-8-GenericCloud-8.10-20240819.x86_64.qcow2
name=tinkerbell

cp $src /tmp/$name.qcow2

virt-install \
  --import \
  --name $name \
  --memory 4048 \
  --vcpus 8 \
  --disk /tmp/$name.qcow2,format=qcow2,bus=virtio \
  --cloud-init user-data=/tmp/user-data,meta-data=/tmp/meta-data \
  --graphics vnc,listen=0.0.0.0 \
  --os-variant rhel8.0 \
  --console pty,target_type=serial \
  --noautoconsole

virsh start tinkerbell
virsh console tinkerbell

[root@localhost ~]# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 52:54:00:a8:a5:2e brd ff:ff:ff:ff:ff:ff
    altname enp1s0
    inet 192.168.122.201/24 brd 192.168.122.255 scope global dynamic noprefixroute eth0
       valid_lft 3590sec preferred_lft 3590sec
    inet6 fe80::5054:ff:fea8:a52e/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
[root@localhost ~]# ping 4.2.2.2
PING 4.2.2.2 (4.2.2.2) 56(84) bytes of data.
64 bytes from 4.2.2.2: icmp_seq=1 ttl=56 time=9.72 ms

--- 4.2.2.2 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 9.724/9.724/9.724/0.000 ms

ssh 192.168.122.201
The authenticity of host '192.168.122.201 (192.168.122.201)' can't be established.
ECDSA key fingerprint is SHA256:Fz+3GEJMVzOfU3noN6RlV07q05XobqAQS6W0VJYOJBY.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '192.168.122.201' (ECDSA) to the list of known hosts.
root@192.168.122.201's password:
Activate the web console with: systemctl enable --now cockpit.socket

Last login: Wed Apr 23 18:46:21 2025

```

## setup tinkerbell

### install docker

```sh
dnf config-manager --add-repo https://download.docker.com/linux/rhel/docker-ce.repo

dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

systemctl enable --now docker

docker ps -a
```

### install k3d

k3d is a lightweight wrapper to run k3s in docker. It is a great way to run Kubernetes clusters locally.

```sh
curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

k3d --help

k3d cluster list
k3d cluster delete k3s-default

# K3D_FIX_DNS=false is needed because host network mode won't work without it.
K3D_FIX_DNS=false k3d cluster create --network host --no-lb --k3s-arg "--disable=traefik,servicelb,metrics-server,local-storage"

# `--network host` : host network is used to allow the load balancer to advertise a layer 2 address.
# `--no-lb` : the K3D built in load balancer is disabled so we don't have conflicts with the stack load balancer.
# `--k3s-arg "--disable=traefik,servicelb,metrics-server,local-storage"` : disable the built in K3S load balancer, metrics server, and local storage.

k3d cluster list
> NAME          SERVERS   AGENTS   LOADBALANCER
> k3s-default   1/1       0/0      false

mkdir -p ~/.kube
k3d kubeconfig get k3s-default > ~/.kube/config

cat ~/.kube/config

docker logs -f k3d-k3s-default-server-0
```

## install kubectl

```sh
cd /tmp

curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"

install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
```

## install helm

```sh
cd /tmp
curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
chmod 700 get_helm.sh
./get_helm.sh

helm version
```

## install k9s

```sh
cd /tmp
wget https://github.com/derailed/k9s/releases/download/v0.26.7/k9s_Linux_x86_64.tar.gz
tar xvf k9s_Linux_x86_64.tar.gz
mv k9s /usr/local/bin/
```

## Install the Tinkerbell stack Helm chart

```sh
# 0.6.2
# export LOADBALANCER_IP=192.168.254.201
# export LOADBALANCER_INTERFACE=eno1
# export HELM_CHART_VERSION=0.6.2
# export NAMESPACE=tinkerbell

# trusted_proxies=$(kubectl get nodes -o jsonpath='{.items[*].spec.podCIDR}' | tr ' ' ',')

# helm install tink-stack oci://ghcr.io/tinkerbell/charts/stack \
# 	--version $HELM_CHART_VERSION \
# 	--create-namespace \
# 	--namespace $NAMESPACE \
# 	--wait \
# 	--set "smee.trustedProxies={${trusted_proxies}}" \
# 	--set "hegel.trustedProxies={${trusted_proxies}}" \
# 	--set "stack.kubevip.interface=$LOADBALANCER_INTERFACE" \
# 	--set "stack.relay.sourceInterface=$LOADBALANCER_INTERFACE" \
# 	--set "stack.loadBalancerIP=$LOADBALANCER_IP" \
# 	--set "smee.publicIP=$LOADBALANCER_IP"

# 0.17
trusted_proxies=$(kubectl get nodes -o jsonpath='{.items[*].spec.podCIDR}' | tr ' ' ',')
export HELM_CHART_VERSION=v0.17
export LB_IP=192.168.254.201
export ARTIFACTS_FILE_SERVER=http://192.168.254.49:8080 # server itself ip 왜 그렇지?
export NAMESPACE=tinkerbell

helm install tinkerbell oci://ghcr.io/tinkerbell/charts/tinkerbell \
  --version "$HELM_CHART_VERSION" \
  --create-namespace \
  --namespace tinkerbell \
  --wait \
  --set "trustedProxies={${trusted_proxies}}" \
  --set "publicIP=$LB_IP" \
  --set "artifactsFileServer=$ARTIFACTS_FILE_SERVER"

kubectl get pods -n tinkerbell

NAME                          READY   STATUS    RESTARTS   AGE
hookos-56f8657b74-m6kdj       2/2     Running   0          21s
kube-vip-cdh2j                1/1     Running   0          21s
tinkerbell-85c8fd5fff-hrzf9   1/1     Running   0          21s

kubectl get svc -n tinkerbell

NAME         TYPE           CLUSTER-IP      EXTERNAL-IP       PORT(S)                                                                                                 AGE
hookos       LoadBalancer   10.43.24.213    192.168.254.49    8080:30400/TCP                                                                                          35s
tinkerbell   LoadBalancer   10.43.102.185   192.168.254.201   42113:32379/TCP,50061:32429/TCP,69:31234/UDP,514:31806/UDP,67:31232/UDP,7171:30483/TCP,2222:31407/TCP   35s

mkdir -p /data/git

cd /data/git

git clone https://github.com/teamsmiley/tinkerbell-example.git

cd /data/git/tinkerbell-example/example

kcn tinkerbell

k get pods
k get svc

k delete -f template
git pull
k apply -f template/

k delete -f dev2
git pull
k apply -f dev2/

k delete -f test
git pull
k apply -f test/

k describe workflow test2  # workflow 상태보기

k apply -f download-image/
```
